services:
    # PostgreSQL Database
    postgres:
        image: ${POSTGRES_IMAGE:-postgres:17-alpine}
        container_name: agris-postgres
        environment:
            POSTGRES_USER: ${POSTGRES_SUPERUSER:-postgres}
            POSTGRES_PASSWORD: ${POSTGRES_SUPERPASS:-postgres}
        ports:
            - "${POSTGRES_PORT:-5432}:5432"
        volumes:
            - pg_data:/var/lib/postgresql/data
            - ./00_bootstrap.sql:/docker-entrypoint-initdb.d/00_bootstrap.sql:ro
            - ./userdb/01_init_user_db.sql:/docker-entrypoint-initdb.d/01_init_user_db.sql:ro
            - ./productdb/01_init_product_db.sql:/docker-entrypoint-initdb.d/02_init_product_db.sql:ro
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_SUPERUSER:-postgres} -d postgres",
                ]
            interval: 10s
            timeout: 5s
            retries: 10
        networks:
            - agris-network
        restart: unless-stopped

    # Redis Cache
    redis:
        image: ${REDIS_IMAGE:-redis:7-alpine}
        container_name: agris-redis
        command: redis-server --requirepass ${REDIS_PASSWORD:-redis_password} --appendonly yes
        ports:
            - "${REDIS_PORT:-6379}:6379"
        volumes:
            - redis_data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
            interval: 10s
            timeout: 3s
            retries: 5
        networks:
            - agris-network
        restart: unless-stopped

#    # Traefik API Gateway
#    traefik:
#        image: ${TRAEFIK_IMAGE:-traefik:v2.10}
#        container_name: agris-traefik
#        command:
#            - "--api.insecure=true"
#            - "--providers.docker=true"
#            - "--providers.docker.exposedbydefault=false"
#            - "--entrypoints.web.address=:80"
#            - "--entrypoints.websecure.address=:443"
#            - "--log.level=INFO"
#        ports:
#            - "${TRAEFIK_HTTP_PORT:-80}:80"
#            - "${TRAEFIK_HTTPS_PORT:-443}:443"
#            - "${TRAEFIK_DASHBOARD_PORT:-8080}:8080"
#        volumes:
#            - /var/run/docker.sock:/var/run/docker.sock:ro
#        networks:
#            - agris-network
#        restart: unless-stopped
#        depends_on:
#            - postgres
#            - redis

volumes:
    pg_data:
        driver: local
    redis_data:
        driver: local

networks:
    agris-network:
        driver: bridge
